---
title: "Messages"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Messages}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

#withr::local_options(joyn.verbose = FALSE)
#withr::local_options(joyn.match_type = "1:1")
withr::local_options(joyn.verbose = TRUE)

```

‚úÖ This vignette is dedicated to one specific feature of `joyn` displaying information through **messages**.

Messages in `joyn` are intended to inform you about the status of your join and the data tables involved. We'll start with a rough overview of the different kinds of messages that might be generated when merging two data tables, then discuss each of them in detail with representative examples.

## Overview

Joyn messages can be of 4 different types:

1.  <span style = "color: #228B22;">**Info**

2.  `<span style = "color: #`{=html}0000B8`;">`{=html}**Timing**

3.  `<span style = "color: #`{=html}FE5A1D`;">`{=html}**Warning**

4.  `<span style = "color: #`{=html}CE2029`;">`{=html}**Error**

```{r setup}

# Setup 
library(joyn)
library(data.table)
library(cli)

```

```{r msg-type}

# Checking available types of messages
msgs_types = joyn:::type_choices()
print(msgs_types)

```

### Information messages ‚ÑπÔ∏è {style="color: green"}

Info messages are intended to inform you about XXX TODO, as you can see in the examples below.

Recall that one of the additional features of joyn is that it returns a reporting variable with the status of the join. Examples in this regard include info messages that tell you in which variable it is available the `joyn` report, or if the reporting variable is not returned instead. Also, an info message might let you know that the name you want to assign to the reporting variable is already present in the returning table, so that it will be changed to a another one.

```{r info-ex1}

# Example dataframes

x1 = data.table(id = c(1L, 1L, 2L, 3L, NA_integer_),
                t  = c(1L, 2L, 1L, 2L, NA_integer_),
                x  = 11:15)

y1 = data.table(id = c(1,2, 4),
                y  = c(11L, 15L, 16))


x2 = data.table(id = c(1, 4, 2, 3, NA),
                t  = c(1L, 2L, 1L, 2L, NA_integer_),
                x  = c(16, 12, NA, NA, 15))


y2 = data.table(id = c(1, 2, 5, 6, 3),
                yd = c(1, 2, 5, 6, 3),
                y  = c(11L, 15L, 20L, 13L, 10L),
                x  = c(16:20))


# ------------------- Showing which var contains joyn report -------------------

# Joining x2 and y2
joyn(x              = x2,
     y              = y2,
     by             = "id", 
     y_vars_to_keep = FALSE)

# Printing the info message
joyn_msg(type = "info")

# ---------------- Info about change in reporting variable name ----------------
joyn(x              = x2,
     y              = y2,
     by             = "id", 
     reportvar      = "x",
     y_vars_to_keep = FALSE)

joyn_msg(type = "info")

# ------------- Informing that reporting variable is not returned -------------
joyn(x              = x2,
     y              = y2,
     by             = "id", 
     reportvar      = FALSE,
     y_vars_to_keep = FALSE)

joyn_msg(type = "info")


```

Furthermore, info messages will help you keep track of which variables in `y` will be kept after the merging, for example notifying you if any of the y variables you have specified to keep will be removed because they are part of the `by` variables.

```{r info-ex2}

joyn(x              = x2,
     y              = y2,
     by             = "id", 
     y_vars_to_keep = TRUE)

joyn_msg(type = "info")

```

Another instance when info messages come in handy is when the options `update_NAs` or `update_values` are set to FALSE. In this case, a message will be generated so that you know which variables are being ignored.

```{r info-x3}

#ADD EXAMPLE 

```

### Timing messages üîµ {style="color: blue"}

Timing messages report in how many seconds the join is executed, including the time spent to perform all checks.

```{r timing-ex1}

# Example with full join

joyn(x          = x1, 
     y          = y1, 
     match_type = "m:1")

joyn_msg("timing")


# Example with left join 
left_join(x            = x1, 
          y            = y1, 
          relationship = "many-to-one")

```

### Warning messages ‚ö†Ô∏è {style="color: orange"}

`joyn` generates warning messages to alert you about possible problematic situation which however do not warrant terminating execution of the merge. For example, if you provide a match type that is inconsistent with the data, `joyn` will generate a warning to inform you about the actual relationship and to alert that the join will be executed accordingly.

In the example below, both `x2` and `y2` are uniquely identified by the key `id`, but the user is choosing a "one to many" relationship instead. The user will be alerted and a "one to one" join will be executed instead.

```{r warn-ex1}

# Warning that "id" uniquely identify y2 

joyn(x2, y2, by = "id", match_type = "1:m", verbose = TRUE)
joyn_msg("warn")

```

Other examples of warnings are those that arise when you are trying to supply certain arguments to the merging functions that are not yet supported by the current version of `joyn`. Suppose you are executing a left-join and you try to set the `na_matches` argument to 'never'. `joyn` will warn you that it currently allows only `na_matches = 'na'`. A similar message is displayed when `keep = NULL`. Given that the current version of `joyn` does not support inequality joins, `joyn` will warn you that `keep = NULL` will make the join retain only keys in `x`.

```{r}

joyn::left_join(x            = x1, 
                y            = y1, 
                relationship = "many-to-one", 
                keep         = NULL,
                na_matches   = "never")

joyn_msg("warn")

```

### Error messages ‚ùå {style="color: red"}

```{r}

check_match_type(x = x1, y=y1, by="id", match_type = "1:1")
joyn_msg("err")

```
